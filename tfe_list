import requests
import os
import json

# --- Configurações do Terraform Enterprise ---
TFE_HOSTNAME = "https://app.terraform.io"  # Ou seu hostname customizado do Terraform Enterprise
TFE_TOKEN = os.environ.get("TFE_TOKEN") # Recomenda-se usar uma variável de ambiente para o token
ORGANIZATION_NAME = "sua-organizacao" # Substitua pela sua organização

def make_tfe_request(method, path, data=None):
    """
    Função auxiliar para fazer requisições à API do Terraform Enterprise.
    """
    headers = {
        "Authorization": f"Bearer {TFE_TOKEN}",
        "Content-Type": "application/vnd.api+json",
    }
    url = f"{TFE_HOSTNAME}/api/v2/{path}"

    try:
        if method == "GET":
            response = requests.get(url, headers=headers)
        elif method == "POST":
            response = requests.post(url, headers=headers, json=data)
        elif method == "PATCH":
            response = requests.patch(url, headers=headers, json=data)
        elif method == "DELETE":
            response = requests.delete(url, headers=headers)
        else:
            raise ValueError(f"Método HTTP '{method}' não suportado.")

        response.raise_for_status() # Lança uma exceção para códigos de status HTTP 4xx/5xx
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Erro na requisição para {url}: {e}")
        if hasattr(e, 'response') and e.response is not None:
            print(f"Status Code: {e.response.status_code}")
            print(f"Response Body: {e.response.text}")
        raise # Re-lança a exceção para que a função chamadora possa lidar com ela

def list_vcs_identifiers():
    """
    Lista os nomes dos VCS identifiers configurados na organização do Terraform Enterprise.
    """
    if not TFE_TOKEN:
        print("Erro: A variável de ambiente TFE_TOKEN não está definida. Por favor, defina-a.")
        return

    # Primeiro, obter o ID da organização
    try:
        org_response = make_tfe_request("GET", f"organizations/{ORGANIZATION_NAME}")
        organization_id = org_response["data"]["id"]
        print(f"Organização '{ORGANIZATION_NAME}' encontrada (ID: {organization_id}).")
    except Exception as e:
        print(f"Erro ao obter a organização '{ORGANIZATION_NAME}': {e}")
        return

    # Em seguida, listar os OAuth Tokens (que representam os VCS Providers)
    try:
        oauth_tokens_response = make_tfe_request("GET", f"organizations/{organization_id}/oauth-tokens")
        
        oauth_tokens_data = oauth_tokens_response["data"]
        
        if oauth_tokens_data:
            print("\nNomes dos VCS Identifiers encontrados:")
            for token in oauth_tokens_data:
                # Usar .get() para acessar atributos para evitar KeyError se a chave não existir
                provider_type = token.get("attributes", {}).get("provider-type", "N/A")
                provider_username = token.get("attributes", {}).get("provider-username", "N/A")

                # Adicione uma depuração extra para ver a estrutura completa do token se o erro persistir
                # print(f"DEBUG: Token completo: {json.dumps(token, indent=2)}")

                print(f"- Tipo: {provider_type}, Identificador: {provider_username}")
        else:
            print(f"Nenhum VCS Identifier encontrado para a organização '{ORGANIZATION_NAME}'.")

    except Exception as e:
        print(f"Ocorreu um erro ao listar os VCS Identifiers: {e}")

if __name__ == "__main__":
    list_vcs_identifiers()
