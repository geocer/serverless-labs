# locals.tf - dentro de ecs_service_configs.container_definitions

container_definitions = {
  for container_name, container_def in service_attrs.container_definitions : container_name => {
    name        = container_name
    image       = container_def.image
    essential   = lookup(container_def, "essential", true)
    cpu         = lookup(container_def, "cpu", null)
    memory      = lookup(container_def, "memory", null)
    environment = [for k, v in lookup(container_def, "environment", {}) : {
      name  = k
      value = v
    }]
    firelens_configuration = merge({}, lookup(container_def, "firelens_configuration", {}))
    log_configuration = lookup(container_def, "log_configuration", null)
    port_mappings = lookup(container_def, "container_port", null) != null ? [
      {
        containerPort = container_def.container_port
        protocol      = "tcp"
      }
    ] : []

    # ESTE É O AJUSTE CRÍTICO:
    # Inclui repository_credentials SOMENTE se credentials_parameter existir e não for nulo
    repository_credentials = (
      lookup(container_def, "repository_credentials", null) != null &&
      lookup(container_def.repository_credentials, "credentials_parameter", null) != null
    ) ? {
      credentials_parameter = container_def.repository_credentials.credentials_parameter
    } : null # Retorna null para omitir o bloco inteiro
  }
}
